<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>账号库·活动·中奖统计系统（云端版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-body: #f5f6fa;
      --bg-card: #ffffff;
      --border-subtle: #e5e7eb;
      --text-main: #111827;
      --text-soft: #6b7280;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --accent-strong: #1d4ed8;
      --danger: #dc2626;
      --danger-soft: #fee2e2;
      --success: #16a34a;
      --success-soft: #dcfce7;
      --shadow-soft: 0 10px 30px rgba(15,23,42,.06);
      --radius-lg: 14px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC",
        "Microsoft YaHei", sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
    }

    body {
      -webkit-font-smoothing: antialiased;
    }

    .app-shell {
      max-width: 1180px;
      margin: 0 auto;
      padding: 16px;
    }

    .app-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .app-title {
      font-size: 20px;
      font-weight: 700;
    }

    .app-subtitle {
      font-size: 13px;
      color: var(--text-soft);
    }

    .tabs {
      display: inline-flex;
      background: #e5e7eb;
      border-radius: var(--radius-pill);
      padding: 2px;
    }

    .tab-btn {
      border: none;
      background: transparent;
      padding: 6px 14px;
      font-size: 13px;
      border-radius: var(--radius-pill);
      cursor: pointer;
      color: #4b5563;
      white-space: nowrap;
    }

    .tab-btn.active {
      background: #ffffff;
      color: var(--accent-strong);
      box-shadow: 0 6px 16px rgba(37,99,235,.18);
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 16px 18px;
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .section-desc {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 14px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px 14px;
      margin-bottom: 10px;
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
    }

    .form-label {
      color: var(--text-soft);
    }

    .input, .select, .textarea {
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      padding: 7px 9px;
      font-size: 13px;
      outline: none;
      width: 100%;
    }

    .input:focus,
    .select:focus,
    .textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    .textarea {
      resize: vertical;
      min-height: 38px;
      max-height: 160px;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 16px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--accent-strong);
      color: #fff;
    }

    .btn-outline {
      background: #fff;
      color: var(--accent-strong);
      border: 1px solid var(--accent-soft);
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
    }

    .btn-xs {
      padding: 3px 10px;
      font-size: 11px;
      border-radius: 999px;
    }

    .chip-status {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
    }
    .chip-status-ok {
      background: var(--success-soft);
      color: var(--success);
    }
    .chip-status-stop {
      background: var(--danger-soft);
      color: var(--danger);
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .toolbar-left,
    .toolbar-right {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .toolbar-search {
      min-width: 180px;
    }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: #fff;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 800px;
      font-size: 12px;
    }

    thead {
      background: #f9fafb;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #f3f4f6;
      text-align: left;
      white-space: nowrap;
    }

    th {
      color: #6b7280;
      font-weight: 500;
      position: sticky;
      top: 0;
      background: #f9fafb;
      z-index: 1;
    }

    tbody tr:nth-child(even) {
      background: #fafafa;
    }

    .text-right {
      text-align: right;
    }

    .muted {
      color: var(--text-soft);
    }

    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f3f4ff;
      color: #4f46e5;
      font-size: 11px;
    }

    .pill-badge {
      font-size: 11px;
      border-radius: 999px;
      padding: 2px 8px;
      background: #eef2ff;
      color: #4f46e5;
    }

    /* 弹窗 */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.38);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 24px 60px rgba(15,23,42,.38);
      max-width: 520px;
      width: calc(100% - 32px);
      max-height: calc(100vh - 80px);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 12px 16px;
      border-bottom: 1px solid #f3f4f6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 14px;
      font-weight: 600;
    }

    .modal-body {
      padding: 12px 16px 14px;
      font-size: 12px;
      overflow: auto;
    }

    .modal-footer {
      padding: 10px 16px 12px;
      border-top: 1px solid #f3f4f6;
      text-align: right;
    }

    .close-x {
      border: none;
      background: transparent;
      padding: 0;
      font-size: 18px;
      cursor: pointer;
      color: #9ca3af;
      line-height: 1;
    }

    /* 简单统计条 */
    .stat-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 6px;
    }
    .stat-chip {
      font-size: 11px;
      padding: 2px 10px;
      border-radius: 999px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    /* 登录遮罩 */
    .login-mask {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #1d4ed8 0, #020617 45%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      color: #fff;
    }

    .login-panel {
      width: 320px;
      max-width: calc(100% - 40px);
      background: rgba(15,23,42,.9);
      border-radius: 18px;
      padding: 22px 20px 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.6);
      border: 1px solid rgba(148,163,184,.5);
    }

    .login-title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .login-subtitle {
      font-size: 12px;
      color: #cbd5f5;
      margin-bottom: 14px;
    }

    .login-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: rgba(15,23,42,.8);
      padding: 7px 11px;
      color: #e5e7eb;
      outline: none;
      font-size: 13px;
    }

    .login-input:focus {
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px rgba(96,165,250,.5);
    }

    .login-btn {
      margin-top: 12px;
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 7px 0;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .login-hint {
      margin-top: 8px;
      font-size: 11px;
      color: #9ca3af;
    }

    .hidden {
      display: none !important;
    }

    /* ============= 小屏（手机）自适应 ============= */
    @media (max-width: 768px) {
      .app-shell {
        padding: 10px 8px 12px;
      }
      .app-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .app-title {
        font-size: 17px;
      }
      .app-subtitle {
        font-size: 11px;
      }
      .tabs {
        width: 100%;
        overflow-x: auto;
      }
      .tab-btn {
        font-size: 12px;
        padding: 6px 10px;
      }
      .card {
        padding: 12px 10px;
        border-radius: 12px;
      }
      .form-grid {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }
      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }
      .toolbar-left,
      .toolbar-right {
        width: 100%;
        justify-content: flex-start;
      }
      .toolbar-search {
        flex: 1;
        min-width: 0;
      }
      .btn-row {
        flex-wrap: wrap;
      }
      table {
        font-size: 11px;
        min-width: 640px;
      }
      th, td {
        padding: 5px 6px;
      }
    }
  </style>
</head>
<body>
  <!-- 登录遮罩 -->
  <div id="loginMask" class="login-mask">
    <div class="login-panel">
      <div class="login-title">宝可梦账号库云端系统</div>
      <div class="login-subtitle">请输入访问密码进入（仅你自己使用）</div>
      <input id="loginPassword" type="password" class="login-input" placeholder="访问密码" />
      <button id="loginSubmit" class="login-btn">进入系统</button>
      <div class="login-hint">当前密码：你设定的 6 位数字（本次为 568568）。可在代码中自行更改。</div>
    </div>
  </div>

  <!-- 主应用 -->
  <div id="appRoot" class="app-shell hidden">
    <header class="app-header">
      <div>
        <div class="app-title">账号库·活动·中奖统计系统（云端版）</div>
        <div class="app-subtitle">
          支持多端访问 + 账号库管理 + 活动参与记录 + 中奖统计。数据自动同步 Supabase，仅你可访问。
        </div>
      </div>
      <div class="tabs">
        <button class="tab-btn active" data-tab="accounts">账号库</button>
        <button class="tab-btn" data-tab="activities">活动管理</button>
        <button class="tab-btn" data-tab="wins">中奖记录</button>
        <button class="tab-btn" data-tab="stats">统计概览</button>
      </div>
    </header>

    <!-- 账号库 -->
    <section id="tab-accounts" class="card">
      <div class="section-title">账号库管理</div>
      <div class="section-desc">
        用于录入和维护所有邮箱账号状态。支持批量新增、批量修改状态、批量删除，并实时统计每个账号的中奖情况。
      </div>

      <!-- 新建 / 编辑账号表单 -->
      <div class="form-grid">
        <div class="form-field">
          <span class="form-label">账号 ID（自动）</span>
          <input id="accId" class="input" placeholder="保存时自动生成，如 A0001" disabled />
        </div>
        <div class="form-field">
          <span class="form-label">邮箱地址</span>
          <input id="accEmail" class="input" placeholder="例如：xxx@outlook.com" />
        </div>
        <div class="form-field">
          <span class="form-label">账号状态</span>
          <select id="accStatus" class="select">
            <option value="可用">可用</option>
            <option value="停用">停用</option>
          </select>
        </div>
        <div class="form-field">
          <span class="form-label">标签 / 分组</span>
          <input id="accTag" class="input" placeholder="例如：主号 / 备用 / JP / US" />
        </div>
        <div class="form-field" style="grid-column: 1/-1;">
          <span class="form-label">备注</span>
          <textarea id="accNote" class="textarea" placeholder="这里不用写详细地址，只写你需要的备注即可。"></textarea>
        </div>
      </div>
      <div class="btn-row">
        <button id="btnNewAccount" class="btn btn-outline">新建账号</button>
        <button id="btnSaveAccount" class="btn btn-primary">保存账号</button>
      </div>

      <!-- 工具条：搜索 + 批量操作 + 文本导入 -->
      <div style="margin-top:16px;" class="section-title">账号列表</div>
      <div class="section-desc">
        多选账号可批量修改状态或删除；删除账号会同时删除该账号的中奖记录和参与记录。
      </div>

      <div class="toolbar">
        <div class="toolbar-left">
          <input id="accSearch" class="input toolbar-search" placeholder="搜索邮箱 / 标签 / 备注" />
          <select id="filterStatus" class="select">
            <option value="全部">全部状态</option>
            <option value="可用">仅可用</option>
            <option value="停用">仅停用</option>
          </select>
          <select id="batchStatus" class="select">
            <option value="">批量状态</option>
            <option value="可用">改为可用</option>
            <option value="停用">改为停用</option>
          </select>
          <button id="btnBatchStatus" class="btn btn-outline">批量修改状态</button>
          <button id="btnBatchDelete" class="btn btn-danger">批量删除</button>
        </div>
        <div class="toolbar-right">
          <span class="muted" id="accSummaryText"></span>
        </div>
      </div>

      <!-- 文本批量新增 -->
      <div class="card" style="padding:10px 10px 12px;margin-bottom:12px;">
        <div class="section-desc" style="margin-bottom:8px;">
          从文本批量新增邮箱（每一行一个邮箱地址）：
        </div>
        <textarea id="bulkEmails" class="textarea" placeholder="例如：&#10;aaa@example.com&#10;bbb@outlook.com"></textarea>
        <div class="btn-row" style="margin-top:6px;">
          <button id="btnBulkAdd" class="btn btn-outline">从文本批量新增邮箱</button>
        </div>
      </div>

      <!-- 列表 -->
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th style="width:32px;"><input type="checkbox" id="checkAll" /></th>
              <th style="width:70px;">ID</th>
              <th>邮箱</th>
              <th>状态</th>
              <th>标签</th>
              <th class="text-right">总中奖次数</th>
              <th>最近中奖</th>
              <th>创建日期</th>
              <th style="width:120px;">操作</th>
            </tr>
          </thead>
          <tbody id="accountTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- 活动管理 -->
    <section id="tab-activities" class="card hidden">
      <div class="section-title">活动管理</div>
      <div class="section-desc">
        每次宝可梦官方活动可建一条记录，支持统计参与账号数量、中奖数量和中奖比例，并可以查看活动的中奖详情。
      </div>

      <div class="form-grid">
        <div class="form-field">
          <span class="form-label">本期活动名称</span>
          <input id="actName" class="input" placeholder="例如：11-11 日本活动 A0001" />
        </div>
        <div class="form-field">
          <span class="form-label">活动日期</span>
          <input id="actDate" class="input" type="date" />
        </div>
        <div class="form-field">
          <span class="form-label">备注</span>
          <input id="actNote" class="input" placeholder="例如：本期发券、国区限定等" />
        </div>
      </div>
      <div class="btn-row">
        <button id="btnNewActivity" class="btn btn-primary">新增活动</button>
      </div>

      <div style="margin-top:12px;" class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th style="width:80px;">活动 ID</th>
              <th>活动名称</th>
              <th>日期</th>
              <th class="text-right">参与账号数</th>
              <th class="text-right">中奖账号数</th>
              <th class="text-right">中奖比例</th>
              <th style="width:120px;">操作</th>
            </tr>
          </thead>
          <tbody id="activityTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- 中奖记录 -->
    <section id="tab-wins" class="card hidden">
      <div class="section-title">中奖记录录入</div>
      <div class="section-desc">
        活动结束后，在这里录入中奖账号。系统会自动更新账号库的中奖次数和最近中奖时间，并同步到云端。
      </div>

      <div class="form-grid">
        <div class="form-field">
          <span class="form-label">选择活动</span>
          <select id="winActivitySelect" class="select"></select>
        </div>
        <div class="form-field">
          <span class="form-label">中奖账号邮箱</span>
          <input id="winEmail" class="input" placeholder="直接输入邮箱或从账号库复制" />
        </div>
        <div class="form-field">
          <span class="form-label">奖品 / 备注</span>
          <input id="winNote" class="input" placeholder="例如：一次券 / 实体奖" />
        </div>
      </div>
      <div class="btn-row">
        <button id="btnAddWin" class="btn btn-primary">录入中奖账号</button>
      </div>

      <div style="margin-top:12px;" class="toolbar">
        <div class="toolbar-left">
          <span class="muted" id="winSummaryText"></span>
        </div>
        <div class="toolbar-right">
          <button id="btnExportCurrentActivityWins" class="btn btn-outline">导出当前活动中奖账号 CSV</button>
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th style="width:80px;">记录 ID</th>
              <th>活动</th>
              <th>邮箱</th>
              <th>时间</th>
              <th>备注</th>
            </tr>
          </thead>
          <tbody id="winTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- 简单统计 -->
    <section id="tab-stats" class="card hidden">
      <div class="section-title">账号 & 活动统计概览</div>
      <div class="section-desc">
        这里展示账号总数、可用账号数、累计中奖账号数等汇总信息，帮助你快速评估当前账号池效果。
      </div>
      <div id="statsContent" style="font-size:13px;"></div>
    </section>
  </div>

  <!-- 详情弹窗 -->
  <div id="detailModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="detailModalTitle">详情</div>
        <button class="close-x" id="detailModalClose">&times;</button>
      </div>
      <div class="modal-body" id="detailModalBody"></div>
      <div class="modal-footer">
        <button class="btn btn-outline btn-xs" id="detailModalClose2">关闭</button>
      </div>
    </div>
  </div>

  <script>
    // ===== 基本配置 =====
    const ACCESS_PASSWORD = "568568"; // 登录密码
    const SUPABASE_URL = "https://nuwqhopuszsbystlioku.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51d3Fob3B1c3pzYnlzdGxpb2t1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MjQ0ODIsImV4cCI6MjA4MTAwMDQ4Mn0.WzW8gnd_-CmGLRsG85ETH9PxRNT12xF6tuQiWArGo-4";
    const DATASET_ID = "main-dataset";

    const LS_KEY = {
      accounts: "acc_act_accounts",
      activities: "acc_act_activities",
      wins: "acc_act_wins",
    };

    let accounts = [];
    let activities = [];
    let wins = [];
    let editingAccountId = null;

    // ===== 工具函数 =====
    function formatDate(dt) {
      if (!dt) return "";
      const d = new Date(dt);
      if (Number.isNaN(d.getTime())) return dt;
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function formatDateTime(dt) {
      if (!dt) return "";
      const d = new Date(dt);
      if (Number.isNaN(d.getTime())) return dt;
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}-${m}-${day} ${hh}:${mm}`;
    }

    function nextAccountId() {
      if (!accounts.length) return "A0001";
      const last = accounts[accounts.length - 1].id || "A0000";
      const num = parseInt(last.replace(/^A/, ""), 10) || 0;
      return "A" + String(num + 1).padStart(4, "0");
    }

    function nextActivityId() {
      if (!activities.length) return "ACT001";
      const last = activities[activities.length - 1].id || "ACT000";
      const num = parseInt(last.replace(/^ACT/, ""), 10) || 0;
      return "ACT" + String(num + 1).padStart(3, "0");
    }

    function nextWinId() {
      if (!wins.length) return "W001";
      const last = wins[wins.length - 1].id || "W000";
      const num = parseInt(last.replace(/^W/, ""), 10) || 0;
      return "W" + String(num + 1).padStart(3, "0");
    }

    function saveLocal() {
      localStorage.setItem(LS_KEY.accounts, JSON.stringify(accounts));
      localStorage.setItem(LS_KEY.activities, JSON.stringify(activities));
      localStorage.setItem(LS_KEY.wins, JSON.stringify(wins));
    }

    async function saveRemote() {
      try {
        const payload = {
          id: DATASET_ID,
          data: {
            accounts,
            activities,
            wins,
            updatedAt: new Date().toISOString(),
          },
        };
        const res = await fetch(`${SUPABASE_URL}/rest/v1/dataset`, {
          method: "POST",
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            "Content-Type": "application/json",
            Prefer: "resolution=merge-duplicates",
          },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          const txt = await res.text();
          console.warn("saveRemote error", res.status, txt);
        }
      } catch (e) {
        console.warn("saveRemote failed", e);
      }
    }

    async function loadData() {
      // 1. 尝试从远程加载
      try {
        const res = await fetch(
          `${SUPABASE_URL}/rest/v1/dataset?select=data&id=eq.${encodeURIComponent(
            DATASET_ID
          )}`,
          {
            headers: {
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            },
          }
        );
        if (res.ok) {
          const arr = await res.json();
          if (Array.isArray(arr) && arr.length && arr[0].data) {
            const d = arr[0].data;
            accounts = Array.isArray(d.accounts) ? d.accounts : [];
            activities = Array.isArray(d.activities) ? d.activities : [];
            wins = Array.isArray(d.wins) ? d.wins : [];
            saveLocal();
            return;
          }
        }
      } catch (e) {
        console.warn("load remote failed, fallback to local", e);
      }
      // 2. 本地回退
      accounts = JSON.parse(localStorage.getItem(LS_KEY.accounts) || "[]");
      activities = JSON.parse(localStorage.getItem(LS_KEY.activities) || "[]");
      wins = JSON.parse(localStorage.getItem(LS_KEY.wins) || "[]");
    }

    function updateStats() {
      const statsEl = document.getElementById("statsContent");
      const totalAccounts = accounts.length;
      const activeAccounts = accounts.filter((a) => a.status === "可用").length;
      const stoppedAccounts = accounts.filter((a) => a.status === "停用").length;
      const winAccountSet = new Set(wins.map((w) => w.email));
      const winAccountCount = winAccountSet.size;
      const totalWins = wins.length;

      statsEl.innerHTML = `
        <div class="stat-row">
          <span class="stat-chip">账号总数：${totalAccounts}</span>
          <span class="stat-chip">可用账号：${activeAccounts}</span>
          <span class="stat-chip">停用账号：${stoppedAccounts}</span>
        </div>
        <div class="stat-row">
          <span class="stat-chip">累计中奖账号数：${winAccountCount}</span>
          <span class="stat-chip">累计中奖记录：${totalWins}</span>
        </div>
        <div style="margin-top:8px;font-size:12px;color:#6b7280;">
          所有统计数据基于当前云端同步的数据。如果你在某台设备上修改了账号库，点击任意操作按钮后系统会自动同步。
        </div>
      `;
    }

    // ===== 渲染：账号列表 =====
    function renderAccounts() {
      const tbody = document.getElementById("accountTbody");
      const search = document.getElementById("accSearch").value.trim().toLowerCase();
      const filterStatus = document.getElementById("filterStatus").value;

      let filtered = accounts;
      if (search) {
        filtered = filtered.filter((a) =>
          (a.email || "").toLowerCase().includes(search) ||
          (a.tag || "").toLowerCase().includes(search) ||
          (a.note || "").toLowerCase().includes(search)
        );
      }
      if (filterStatus !== "全部") {
        filtered = filtered.filter((a) => a.status === filterStatus);
      }

      tbody.innerHTML = "";
      filtered.forEach((acc) => {
        const tr = document.createElement("tr");
        const winCount = acc.winCount || 0;
        const lastWin = acc.lastWinAt ? formatDate(acc.lastWinAt) : "-";

        tr.innerHTML = `
          <td><input type="checkbox" class="row-check" data-id="${acc.id}" /></td>
          <td>${acc.id}</td>
          <td>${acc.email || ""}</td>
          <td>
            <span class="chip-status ${
              acc.status === "可用" ? "chip-status-ok" : "chip-status-stop"
            }">${acc.status || "可用"}</span>
          </td>
          <td>${acc.tag ? `<span class="tag">${acc.tag}</span>` : ""}</td>
          <td class="text-right">${winCount}</td>
          <td>${lastWin}</td>
          <td>${acc.createdAt ? formatDate(acc.createdAt) : ""}</td>
          <td>
            <button class="btn btn-outline btn-xs" data-op="detail" data-id="${acc.id}">详情</button>
            <button class="btn btn-outline btn-xs" data-op="edit" data-id="${acc.id}">编辑</button>
            <button class="btn btn-danger btn-xs" data-op="delete" data-id="${acc.id}">删除</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById(
        "accSummaryText"
      ).textContent = `共 ${accounts.length} 个账号，当前筛选显示 ${filtered.length} 个。`;

      // 同步活动下拉 & 统计
      updateActivitySelect();
      updateStats();
    }

    // ===== 渲染：活动 =====
    function updateActivitySelect() {
      const sel = document.getElementById("winActivitySelect");
      sel.innerHTML = "";
      activities.forEach((act) => {
        const opt = document.createElement("option");
        opt.value = act.id;
        opt.textContent = `${act.id} · ${act.name}`;
        sel.appendChild(opt);
      });
      renderActivities();
      renderWins();
    }

    function renderActivities() {
      const tbody = document.getElementById("activityTbody");
      tbody.innerHTML = "";
      activities.forEach((act) => {
        const actWins = wins.filter((w) => w.activityId === act.id);
        const winnerCount = new Set(actWins.map((w) => w.email)).size;
        const joinCount = act.participantCount || 0;
        const ratio =
          joinCount > 0 ? ((winnerCount / joinCount) * 100).toFixed(1) + "%" : "-";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${act.id}</td>
          <td>${act.name || ""}</td>
          <td>${act.date ? formatDate(act.date) : ""}</td>
          <td class="text-right">${joinCount}</td>
          <td class="text-right">${winnerCount}</td>
          <td class="text-right">${ratio}</td>
          <td>
            <button class="btn btn-outline btn-xs" data-op="act-detail" data-id="${act.id}">详情</button>
            <button class="btn btn-danger btn-xs" data-op="act-delete" data-id="${act.id}">删除</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ===== 渲染：中奖记录 =====
    function renderWins() {
      const tbody = document.getElementById("winTbody");
      tbody.innerHTML = "";
      const sel = document.getElementById("winActivitySelect");
      const currentActId = sel.value;
      const filtered = currentActId
        ? wins.filter((w) => w.activityId === currentActId)
        : wins;

      filtered.forEach((w) => {
        const act = activities.find((a) => a.id === w.activityId);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${w.id}</td>
          <td>${act ? act.name : w.activityId}</td>
          <td>${w.email}</td>
          <td>${formatDateTime(w.createdAt)}</td>
          <td>${w.note || ""}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById(
        "winSummaryText"
      ).textContent = `当前活动中奖记录：${filtered.length} 条，全部中奖记录：${wins.length} 条。`;
    }

    // ===== 账号操作 =====
    function resetAccountForm() {
      editingAccountId = null;
      document.getElementById("accId").value = "";
      document.getElementById("accEmail").value = "";
      document.getElementById("accStatus").value = "可用";
      document.getElementById("accTag").value = "";
      document.getElementById("accNote").value = "";
    }

    function handleSaveAccount() {
      const email = document.getElementById("accEmail").value.trim();
      if (!email) {
        alert("请输入邮箱地址");
        return;
      }
      const status = document.getElementById("accStatus").value;
      const tag = document.getElementById("accTag").value.trim();
      const note = document.getElementById("accNote").value.trim();

      if (editingAccountId) {
        const acc = accounts.find((a) => a.id === editingAccountId);
        if (!acc) return;
        acc.email = email;
        acc.status = status;
        acc.tag = tag;
        acc.note = note;
      } else {
        const id = nextAccountId();
        const now = new Date().toISOString();
        accounts.push({
          id,
          email,
          status,
          tag,
          note,
          createdAt: now,
          winCount: 0,
          lastWinAt: null,
        });
      }
      saveLocal();
      saveRemote();
      resetAccountForm();
      renderAccounts();
    }

    function handleAccountRowClick(e) {
      const op = e.target.getAttribute("data-op");
      const id = e.target.getAttribute("data-id");
      if (!op || !id) return;
      const acc = accounts.find((a) => a.id === id);
      if (!acc) return;

      if (op === "edit") {
        editingAccountId = id;
        document.getElementById("accId").value = acc.id;
        document.getElementById("accEmail").value = acc.email || "";
        document.getElementById("accStatus").value = acc.status || "可用";
        document.getElementById("accTag").value = acc.tag || "";
        document.getElementById("accNote").value = acc.note || "";
      } else if (op === "delete") {
        if (!confirm(`确定要删除账号 ${acc.email} 吗？该账号所有中奖记录也会被删除。`))
          return;
        accounts = accounts.filter((a) => a.id !== id);
        wins = wins.filter((w) => w.email !== acc.email);
        saveLocal();
        saveRemote();
        renderAccounts();
        renderWins();
      } else if (op === "detail") {
        const accWins = wins.filter((w) => w.email === acc.email);
        const actNames = {};
        activities.forEach((a) => (actNames[a.id] = a.name));
        const listHtml = accWins
          .map(
            (w) =>
              `<li>${formatDateTime(w.createdAt)} · ${
                actNames[w.activityId] || w.activityId
              } · ${w.note || ""}</li>`
          )
          .join("");
        const bodyHtml = `
          <div style="margin-bottom:8px;">
            <div><strong>邮箱：</strong>${acc.email}</div>
            <div><strong>状态：</strong>${acc.status}</div>
            <div><strong>标签：</strong>${acc.tag || "-"}</div>
            <div><strong>备注：</strong>${acc.note || "-"}</div>
            <div><strong>创建时间：</strong>${
              acc.createdAt ? formatDateTime(acc.createdAt) : "-"
            }</div>
          </div>
          <div style="margin-top:6px;">
            <div style="margin-bottom:4px;"><strong>中奖记录（${accWins.length} 条）：</strong></div>
            ${
              accWins.length
                ? `<ul style="padding-left:18px;margin:0;">${listHtml}</ul>`
                : '<div class="muted">暂无中奖记录。</div>'
            }
          </div>
        `;
        showModal("账号详情", bodyHtml);
      }
    }

    function handleBatchStatus() {
      const status = document.getElementById("batchStatus").value;
      if (!status) {
        alert("请选择要批量修改成的状态");
        return;
      }
      const checked = Array.from(
        document.querySelectorAll(".row-check:checked")
      ).map((c) => c.getAttribute("data-id"));
      if (!checked.length) {
        alert("请至少勾选一个账号");
        return;
      }
      accounts.forEach((a) => {
        if (checked.includes(a.id)) a.status = status;
      });
      saveLocal();
      saveRemote();
      renderAccounts();
    }

    function handleBatchDelete() {
      const checked = Array.from(
        document.querySelectorAll(".row-check:checked")
      ).map((c) => c.getAttribute("data-id"));
      if (!checked.length) {
        alert("请至少勾选一个账号");
        return;
      }
      if (!confirm(`确认删除选中的 ${checked.length} 个账号以及对应中奖记录吗？`))
        return;
      const emailsToRemove = accounts
        .filter((a) => checked.includes(a.id))
        .map((a) => a.email);
      accounts = accounts.filter((a) => !checked.includes(a.id));
      wins = wins.filter((w) => !emailsToRemove.includes(w.email));
      saveLocal();
      saveRemote();
      renderAccounts();
      renderWins();
    }

    function handleBulkAdd() {
      const txt = document.getElementById("bulkEmails").value;
      if (!txt.trim()) {
        alert("请先在文本框内粘贴邮箱列表");
        return;
      }
      const lines = txt
        .split(/\r?\n/)
        .map((v) => v.trim())
        .filter((v) => v);
      if (!lines.length) {
        alert("没有解析到邮箱地址");
        return;
      }
      let added = 0;
      lines.forEach((email) => {
        if (accounts.some((a) => a.email === email)) return;
        accounts.push({
          id: nextAccountId(),
          email,
          status: "可用",
          tag: "",
          note: "",
          createdAt: new Date().toISOString(),
          winCount: 0,
          lastWinAt: null,
        });
        added++;
      });
      if (added === 0) {
        alert("这些邮箱已经全部存在账号库中，未新增。");
      } else {
        saveLocal();
        saveRemote();
        document.getElementById("bulkEmails").value = "";
        renderAccounts();
        alert(`已新增 ${added} 个账号。`);
      }
    }

    // ===== 活动操作 =====
    function handleNewActivity() {
      const name = document.getElementById("actName").value.trim();
      if (!name) {
        alert("请输入活动名称");
        return;
      }
      const date = document.getElementById("actDate").value || null;
      const note = document.getElementById("actNote").value.trim();
      const id = nextActivityId();
      const activeAccounts = accounts.filter((a) => a.status === "可用").length;

      activities.push({
        id,
        name,
        date,
        note,
        participantCount: activeAccounts, // 简单按可用账号数统计参与数
      });
      saveLocal();
      saveRemote();
      document.getElementById("actName").value = "";
      document.getElementById("actDate").value = "";
      document.getElementById("actNote").value = "";
      updateActivitySelect();
    }

    function handleActivityRowClick(e) {
      const op = e.target.getAttribute("data-op");
      const id = e.target.getAttribute("data-id");
      if (!op || !id) return;
      const act = activities.find((a) => a.id === id);
      if (!act) return;
      if (op === "act-delete") {
        if (!confirm(`确定要删除活动 ${act.name} 以及对应的中奖记录吗？`)) return;
        activities = activities.filter((a) => a.id !== id);
        wins = wins.filter((w) => w.activityId !== id);
        saveLocal();
        saveRemote();
        updateActivitySelect();
      } else if (op === "act-detail") {
        const actWins = wins.filter((w) => w.activityId === id);
        const winnerCount = new Set(actWins.map((w) => w.email)).size;
        const ratio =
          act.participantCount > 0
            ? ((winnerCount / act.participantCount) * 100).toFixed(1) + "%"
            : "-";
        const listHtml = actWins
          .map(
            (w) =>
              `<li>${formatDateTime(w.createdAt)} · ${w.email} · ${w.note || ""}</li>`
          )
          .join("");
        const bodyHtml = `
          <div class="stat-row">
            <span class="stat-chip">活动 ID：${act.id}</span>
            <span class="stat-chip">参与账号数：${act.participantCount}</span>
            <span class="stat-chip">中奖账号数：${winnerCount}</span>
            <span class="stat-chip">中奖比例：${ratio}</span>
          </div>
          <div style="margin-top:6px;"><strong>活动名称：</strong>${act.name}</div>
          <div><strong>日期：</strong>${act.date ? formatDate(act.date) : "-"}</div>
          <div><strong>备注：</strong>${act.note || "-"}</div>
          <div style="margin-top:8px;">
            <div style="margin-bottom:4px;"><strong>中奖详情（${actWins.length} 条）：</strong></div>
            ${
              actWins.length
                ? `<ul style="padding-left:18px;margin:0;">${listHtml}</ul>`
                : '<div class="muted">暂无中奖记录。</div>'
            }
          </div>
        `;
        showModal("活动中奖详情", bodyHtml);
      }
    }

    // ===== 中奖操作 =====
    function handleAddWin() {
      const actId = document.getElementById("winActivitySelect").value;
      if (!actId) {
        alert("请先在活动管理中新增活动");
        return;
      }
      const email = document.getElementById("winEmail").value.trim();
      if (!email) {
        alert("请输入中奖账号邮箱");
        return;
      }
      const note = document.getElementById("winNote").value.trim();

      // 避免同一活动同一邮箱重复录入
      const dup = wins.find((w) => w.activityId === actId && w.email === email);
      if (dup) {
        if (
          !confirm(
            "该活动下此邮箱已录入过中奖记录，确定要再次添加吗？（会当做多次中奖）"
          )
        )
          return;
      }

      const id = nextWinId();
      const now = new Date().toISOString();
      wins.push({
        id,
        activityId: actId,
        email,
        note,
        createdAt: now,
      });

      // 更新账号中的统计字段
      const acc = accounts.find((a) => a.email === email);
      if (acc) {
        acc.winCount = (acc.winCount || 0) + 1;
        acc.lastWinAt = now;
      }

      saveLocal();
      saveRemote();
      document.getElementById("winEmail").value = "";
      document.getElementById("winNote").value = "";
      renderAccounts();
      renderWins();
    }

    // 导出当前活动中奖账号 CSV
    function exportCurrentActivityWins() {
      const actId = document.getElementById("winActivitySelect").value;
      if (!actId) {
        alert("请先选择活动");
        return;
      }
      const act = activities.find((a) => a.id === actId);
      const actWins = wins.filter((w) => w.activityId === actId);
      if (!actWins.length) {
        alert("当前活动还没有中奖记录");
        return;
      }
      const rows = [["活动ID", "活动名称", "邮箱", "时间", "备注"]];
      actWins.forEach((w) => {
        rows.push([
          act.id,
          act.name,
          w.email,
          formatDateTime(w.createdAt),
          w.note || "",
        ]);
      });
      const csv = rows
        .map((r) =>
          r
            .map((x) => {
              const s = String(x || "");
              if (s.includes(",") || s.includes('"') || s.includes("\n"))
                return `"${s.replace(/"/g, '""')}"`;
              return s;
            })
            .join(",")
        )
        .join("\n");
      const blob = new Blob(["\ufeff" + csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${act.id}_${act.name}_中奖账号.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ===== 弹窗 =====
    function showModal(title, html) {
      document.getElementById("detailModalTitle").textContent = title;
      document.getElementById("detailModalBody").innerHTML = html;
      document
        .getElementById("detailModalBackdrop")
        .classList.add("show");
    }
    function hideModal() {
      document
        .getElementById("detailModalBackdrop")
        .classList.remove("show");
    }

    // ===== 标签切换 =====
    function initTabs() {
      const tabBtns = document.querySelectorAll(".tab-btn");
      tabBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          tabBtns.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const tab = btn.getAttribute("data-tab");
          ["accounts", "activities", "wins", "stats"].forEach((name) => {
            const sec = document.getElementById("tab-" + name);
            if (!sec) return;
            if (name === tab) sec.classList.remove("hidden");
            else sec.classList.add("hidden");
          });
        });
      });
    }

    // ===== 登录逻辑 =====
    function initLogin() {
      const mask = document.getElementById("loginMask");
      const root = document.getElementById("appRoot");
      const input = document.getElementById("loginPassword");
      const btn = document.getElementById("loginSubmit");

      function tryLogin() {
        const pwd = input.value.trim();
        if (pwd !== ACCESS_PASSWORD) {
          alert("密码错误");
          return;
        }
        mask.classList.add("hidden");
        root.classList.remove("hidden");
        // 登录后加载数据
        loadData().then(() => {
          renderAccounts();
          updateActivitySelect();
          updateStats();
        });
      }

      btn.addEventListener("click", tryLogin);
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") tryLogin();
      });
    }

    // ===== 初始化 =====
    document.addEventListener("DOMContentLoaded", () => {
      initLogin();
      initTabs();

      document
        .getElementById("btnNewAccount")
        .addEventListener("click", resetAccountForm);
      document
        .getElementById("btnSaveAccount")
        .addEventListener("click", handleSaveAccount);
      document
        .getElementById("accountTbody")
        .addEventListener("click", handleAccountRowClick);
      document
        .getElementById("accSearch")
        .addEventListener("input", renderAccounts);
      document
        .getElementById("filterStatus")
        .addEventListener("change", renderAccounts);
      document
        .getElementById("btnBatchStatus")
        .addEventListener("click", handleBatchStatus);
      document
        .getElementById("btnBatchDelete")
        .addEventListener("click", handleBatchDelete);
      document
        .getElementById("btnBulkAdd")
        .addEventListener("click", handleBulkAdd);
      document
        .getElementById("checkAll")
        .addEventListener("change", (e) => {
          document
            .querySelectorAll(".row-check")
            .forEach((c) => (c.checked = e.target.checked));
        });

      document
        .getElementById("btnNewActivity")
        .addEventListener("click", handleNewActivity);
      document
        .getElementById("activityTbody")
        .addEventListener("click", handleActivityRowClick);

      document
        .getElementById("winActivitySelect")
        .addEventListener("change", renderWins);
      document
        .getElementById("btnAddWin")
        .addEventListener("click", handleAddWin);
      document
        .getElementById("btnExportCurrentActivityWins")
        .addEventListener("click", exportCurrentActivityWins);

      document
        .getElementById("detailModalClose")
        .addEventListener("click", hideModal);
      document
        .getElementById("detailModalClose2")
        .addEventListener("click", hideModal);
      document
        .getElementById("detailModalBackdrop")
        .addEventListener("click", (e) => {
          if (e.target.id === "detailModalBackdrop") hideModal();
        });
    });
  </script>
</body>
</html>
